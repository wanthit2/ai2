<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - Food System v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #64748b;
            --bg: #f1f5f9;
            --white: #ffffff;
            --text-main: #0f172a;
        }

        body { 
            font-family: 'Prompt', sans-serif; 
            background: var(--bg); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px;
        }
        
        .edit-container { 
            background: var(--white); 
            padding: 40px; 
            border-radius: 24px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 550px;
        }

        .header-section { text-align: center; margin-bottom: 30px; }
        .header-section h2 { margin: 0; color: var(--text-main); font-size: 1.75rem; }
        .header-section p { color: var(--secondary); margin: 5px 0 0; font-size: 0.9rem; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        
        input, select {
            width: 100%; padding: 14px; border: 2px solid #e2e8f0;
            border-radius: 12px; box-sizing: border-box; outline: none; font-family: 'Prompt';
            transition: all 0.3s;
        }

        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        .image-upload-area {
            width: 100%; height: 220px; border: 2px dashed #cbd5e1;
            border-radius: 16px; margin-bottom: 12px; overflow: hidden;
            display: flex; align-items: center; justify-content: center; background: #f8fafc;
            position: relative; cursor: pointer;
        }
        .image-upload-area img { width: 100%; height: 100%; object-fit: cover; }
        .image-upload-area .placeholder-text { color: #94a3b8; text-align: center; font-size: 0.85rem; }

        .btn-stack { display: flex; flex-direction: column; gap: 12px; margin-top: 30px; }
        
        button {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            cursor: pointer; font-weight: 600; font-family: 'Prompt'; font-size: 1rem;
            transition: all 0.2s;
        }

        .btn-save { background: var(--primary); color: white; }
        .btn-save:hover { background: var(--primary-dark); transform: translateY(-2px); }
        
        .btn-back { background: transparent; color: var(--secondary); border: 1.5px solid #e2e8f0; }
        .btn-back:hover { background: #f8fafc; color: var(--text-main); }
    </style>
</head>
<body>

<div class="edit-container">
    <div class="header-section">
        <h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
        <p>‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
    </div>
    
    <div class="form-group">
        <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
        <div class="image-upload-area" id="dropArea" onclick="document.getElementById('fileInput').click()">
            <div class="placeholder-text" id="placeholder">üì∑ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà</div>
            <img src="" id="currentImage" style="display:none;">
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleImageChange(event)">
    </div>

    <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
        <input type="text" id="foodName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß">
    </div>

    <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
            <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <select id="foodCategory">
                <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                <option value="‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡πâ‡∏≤‡∏ß">‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡πâ‡∏≤‡∏ß</option>
                <option value="‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô">‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô</option>
                <option value="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                <option value="‡∏ã‡∏π‡∏ä‡∏¥">‡∏ã‡∏π‡∏ä‡∏¥</option>
            </select>
        </div>
        <div>
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="foodPrice" placeholder="0.00">
        </div>
    </div>

    <div class="btn-stack">
        <button class="btn-save" id="saveBtn" onclick="submitEdit()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="btn-back" onclick="history.back()">üîô ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
</div>

<script>
    // ‚úÖ 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç API URL ‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå Railway ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const API_URL = "https://ai2-production-18cb.up.railway.app"; 
    const params = new URLSearchParams(window.location.search);
    const foodId = params.get('id');

    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    window.onload = async () => {
        if (!foodId) {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (ID)");
            window.location.href = 'admin_dashboard.html';
            return;
        }

        try {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å Backend
            const res = await fetch(`${API_URL}/get-food/${foodId}`);
            if (!res.ok) throw new Error("Fetch failed");
            const food = await res.json();

            // ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô Input ‡∏ï‡πà‡∏≤‡∏á‡πÜ
            document.getElementById('foodName').value = food.name;
            document.getElementById('foodPrice').value = food.price;
            document.getElementById('foodCategory').value = food.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
            
            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Supabase URL ‡∏ï‡∏£‡∏á‡πÜ ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô /uploads/)
            if (food.image_url) {
                const imgTag = document.getElementById('currentImage');
                imgTag.src = food.image_url; 
                imgTag.style.display = 'block';
                document.getElementById('placeholder').style.display = 'none';
            }
        } catch (err) {
            console.error("Error loading food data:", err);
            alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database)");
        }
    };

    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà (Preview)
    function handleImageChange(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imgTag = document.getElementById('currentImage');
                imgTag.src = e.target.result;
                imgTag.style.display = 'block';
                document.getElementById('placeholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    }

    // 4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
    async function submitEdit() {
        const name = document.getElementById('foodName').value;
        const price = document.getElementById('foodPrice').value;
        const category = document.getElementById('foodCategory').value;
        const fileInput = document.getElementById('fileInput');
        const saveBtn = document.getElementById('saveBtn');

        if (!name || !price) {
            alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            return;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
        saveBtn.disabled = true;
        saveBtn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

        const formData = new FormData();
        formData.append('id', foodId);
        formData.append('name', name);
        formData.append('price', price);
        formData.append('category', category);
        
        if (fileInput.files[0]) {
            formData.append('foodImage', fileInput.files[0]);
        }

        try {
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á API update-food ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            const res = await fetch(`${API_URL}/update-food`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (res.ok) {
                alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                window.location.href = 'admin_dashboard.html';
            } else {
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (data.error || data.message));
            }
        } catch (err) {
            console.error("Submit Error:", err);
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ (Network Error)");
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        }
    }
</script>

</body>
</html>
